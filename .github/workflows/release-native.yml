name: Release Native App

on:
  push:
    branches:
      - staging
      - main
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'prerelease'
        type: choice
        options:
          - prerelease
          - release

permissions:
  contents: write

env:
  PNPM_VERSION: 8
  NODE_VERSION: 20

jobs:
  # ========================================
  # ãƒ“ãƒ«ãƒ‰: macOSå‘ã‘ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒª
  # ========================================
  build-native:
    name: Build Native App
    runs-on: macos-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      environment: ${{ steps.env.outputs.environment }}
      artifact-name: ${{ steps.env.outputs.artifact-name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm run --filter "./packages/**" build

      - name: Determine environment and version
        id: env
        run: |
          # Determine environment based on branch
          if [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            ENV="staging"
            ARTIFACT_NAME="macos-staging"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV="production"
            ARTIFACT_NAME="macos-production"
          else
            ENV="development"
            ARTIFACT_NAME="macos-development"
          fi
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "artifact-name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "ðŸŒ Environment: $ENV"
          echo "ðŸ“¦ Artifact name: $ARTIFACT_NAME"

      - name: Get version
        id: version
        run: |
          VERSION=$(node -p "require('./apps/native/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Version: $VERSION"

      - name: Setup Apple Code Signing (if credentials available)
        if: ${{ env.APPLE_CERTIFICATE_BASE64 != '' && env.APPLE_CERTIFICATE_PASSWORD != '' }}
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo "ðŸ”‘ Setting up Apple Developer ID code signing..."
          
          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          
          # Import certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          
          # Set signing identity
          echo "APPLE_SIGNING_IDENTITY=$(security find-identity -v -p codesigning build.keychain | grep 'Developer ID Application' | head -1 | grep -o '[A-Z0-9]\{40\}')" >> $GITHUB_ENV
          
          echo "âœ… Code signing setup completed"

      - name: Build Tauri app (Environment-specific)
        env:
          APP_ENV: ${{ steps.env.outputs.environment }}
        run: |
          echo "=== Build Environment Debug ==="
          echo "ðŸŒ Environment: ${{ steps.env.outputs.environment }}"
          echo "ðŸ“¦ APP_ENV: $APP_ENV"
          echo "Node: $(node --version)"
          echo "pnpm: $(pnpm --version)"
          echo "Rust: $(rustc --version)"
          
          echo "=== Directory Check ==="
          if [ -d "apps/native" ]; then
            echo "âœ… apps/native exists"
            ls -la apps/native/
          else
            echo "âŒ apps/native not found"
            exit 1
          fi
          
          if [[ -n "$APPLE_SIGNING_IDENTITY" ]]; then
            echo "ðŸ” Building with code signing..."
            export TAURI_SIGNING_PRIVATE_KEY="${{ secrets.TAURI_PRIVATE_KEY }}"
            export TAURI_SIGNING_PRIVATE_KEY_PASSWORD="${{ secrets.TAURI_KEY_PASSWORD }}"
          else
            echo "âš ï¸ Building without code signing (credentials not available)"
          fi
          
          export CI=true
          export SKIP_JENKINS=1
          
          echo "ðŸ—ï¸ Starting environment-specific build process..."
          cd apps/native
          
          echo "=== Environment-specific Build ==="
          case "$APP_ENV" in
            "staging")
              echo "ðŸ”§ Building for staging environment"
              pnpm tauri:build:staging 2>&1 | tee ../build.log || {
                echo "âŒ Staging build failed, trying fallback..."
                APP_ENV=staging pnpm tauri build --target universal-apple-darwin --bundles dmg --verbose
              }
              ;;
            "production")
              echo "ðŸš€ Building for production environment"
              pnpm tauri:build:production 2>&1 | tee ../build.log || {
                echo "âŒ Production build failed, trying fallback..."
                APP_ENV=production pnpm tauri build --target universal-apple-darwin --bundles dmg --verbose
              }
              ;;
            *)
              echo "ðŸ”¨ Building for development environment"
              pnpm tauri:build:dev 2>&1 | tee ../build.log || {
                echo "âŒ Development build failed, trying fallback..."
                APP_ENV=development pnpm tauri build --target universal-apple-darwin --bundles dmg --verbose
              }
              ;;
          esac
          
          cd ../..

      - name: Debug build output
        run: |
          echo "=== Build Target Directories ==="
          ls -la apps/native/src-tauri/target/ || echo "No target directory"
          
          echo "=== Universal Target Check ==="
          if [ -d "apps/native/src-tauri/target/universal-apple-darwin" ]; then
            echo "Universal target directory exists"
            ls -la apps/native/src-tauri/target/universal-apple-darwin/
            if [ -d "apps/native/src-tauri/target/universal-apple-darwin/release" ]; then
              ls -la apps/native/src-tauri/target/universal-apple-darwin/release/
              if [ -d "apps/native/src-tauri/target/universal-apple-darwin/release/bundle" ]; then
                ls -la apps/native/src-tauri/target/universal-apple-darwin/release/bundle/
                if [ -d "apps/native/src-tauri/target/universal-apple-darwin/release/bundle/dmg" ]; then
                  echo "DMG directory exists:"
                  ls -la apps/native/src-tauri/target/universal-apple-darwin/release/bundle/dmg/
                else
                  echo "âŒ DMG directory not found"
                fi
              else
                echo "âŒ Bundle directory not found"
              fi
            else
              echo "âŒ Release directory not found"
            fi
          else
            echo "âŒ Universal target directory not found"
          fi
          
          echo "=== All DMG files in target ==="
          find apps/native/src-tauri/target -name "*.dmg" -type f 2>/dev/null || echo "No DMG files found anywhere"
          
          echo "=== Alternative architectures ==="
          ls -la apps/native/src-tauri/target/ | grep -E "(aarch64|x86_64|release)" || echo "No alternative targets"
          
      - name: Collect all DMG files
        run: |
          echo "=== Collecting all possible DMG files ==="
          mkdir -p ./artifacts
          
          # Find all DMG files anywhere in target
          find apps/native/src-tauri/target -name "*.dmg" -type f 2>/dev/null | while read dmg_file; do
            echo "Found DMG: $dmg_file"
            cp "$dmg_file" ./artifacts/ || echo "Failed to copy $dmg_file"
          done
          
          echo "=== Final artifact list ==="
          ls -la ./artifacts/ || echo "No artifacts directory"
          
          if [ -z "$(ls -A ./artifacts/ 2>/dev/null)" ]; then
            echo "âŒ No DMG files found to upload"
            echo "=== Full target directory structure ==="
            find apps/native/src-tauri/target -type f 2>/dev/null | head -20
          else
            echo "âœ… DMG files ready for upload"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.env.outputs.artifact-name }}
          path: ./artifacts/*.dmg
          if-no-files-found: warn
          retention-days: 7

      - name: Verify artifact upload
        run: |
          echo "=== Verifying DMG files exist before upload ==="
          ls -la apps/native/src-tauri/target/universal-apple-darwin/release/bundle/dmg/ || echo "âŒ DMG directory not found"
          echo "=== DMG files ==="
          find apps/native/src-tauri/target/universal-apple-darwin/release/bundle/dmg/ -name "*.dmg" 2>/dev/null || echo "No DMG files"

  # ========================================
  # Stagingãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹
  # ========================================
  prerelease:
    name: Pre-release (Staging)
    needs: build-native
    if: |
      github.ref == 'refs/heads/staging' || 
      (github.event_name == 'workflow_dispatch' && inputs.release_type == 'prerelease')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./dist

      - name: Debug artifact structure
        run: |
          echo "=== Working directory ==="
          pwd
          ls -la ./
          echo "=== Check if dist exists ==="
          if [ -d "./dist" ]; then
            echo "dist directory exists"
            find ./dist -type f -name "*.dmg" | head -10
            echo "=== All files in dist ==="
            ls -la ./dist/
            if [ -d "./dist/${{ needs.build-native.outputs.artifact-name }}" ]; then
              echo "=== DMG files in ${{ needs.build-native.outputs.artifact-name }} ==="
              ls -la ./dist/${{ needs.build-native.outputs.artifact-name }}/
            fi
          else
            echo "âŒ dist directory does not exist"
            echo "=== Available artifacts might be ==="
            find . -name "*.dmg" 2>/dev/null || echo "No DMG files found"
          fi

      - name: Generate release notes
        id: notes
        run: |
          ENV="${{ needs.build-native.outputs.environment }}"
          VERSION="${{ needs.build-native.outputs.version }}"
          
          case "$ENV" in
            "staging")
              echo "## ðŸš§ Staging Pre-release v${VERSION}-staging.${{ github.run_number }}" > notes.md
              echo "" >> notes.md
              echo "### ðŸ“… Build Information" >> notes.md
              echo "- **Environment**: Staging" >> notes.md
              echo "- **Version**: ${VERSION}-staging.${{ github.run_number }}" >> notes.md
              echo "- **App ID**: com.prompalette.app.staging" >> notes.md
              echo "- **Window Title**: PromPalette [STAGING]" >> notes.md
              echo "- **Data Directory**: PromPalette-Staging/" >> notes.md
              echo "- **Commit**: ${{ github.sha }}" >> notes.md
              echo "- **Build**: #${{ github.run_number }}" >> notes.md
              echo "- **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> notes.md
              echo "" >> notes.md
              echo "### âš ï¸ Notice" >> notes.md
              echo "This is a **staging build** for testing purposes. It uses separate data storage from production." >> notes.md
              echo "You can install this alongside the production version without conflicts." >> notes.md
              ;;
            *)
              echo "## ðŸ”¨ Development Build v${VERSION}-dev.${{ github.run_number }}" > notes.md
              echo "" >> notes.md
              echo "### ðŸ“… Build Information" >> notes.md
              echo "- **Environment**: Development" >> notes.md
              echo "- **Version**: ${VERSION}-dev.${{ github.run_number }}" >> notes.md
              echo "- **App ID**: com.prompalette.app.dev" >> notes.md
              echo "- **Window Title**: PromPalette [DEV]" >> notes.md
              echo "- **Data Directory**: PromPalette-Dev/" >> notes.md
              echo "- **Commit**: ${{ github.sha }}" >> notes.md
              echo "- **Build**: #${{ github.run_number }}" >> notes.md
              echo "- **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> notes.md
              echo "" >> notes.md
              echo "### âš ï¸ Notice" >> notes.md
              echo "This is a **development build** for testing purposes. It uses separate data storage." >> notes.md
              ;;
          esac
          
          echo "" >> notes.md
          echo "### ðŸ“¦ Installation" >> notes.md
          echo "1. Download the .dmg file below" >> notes.md
          echo "2. Open the downloaded file" >> notes.md
          echo "3. Drag PromPalette to your Applications folder" >> notes.md
          echo "4. The app will be installed with environment-specific naming" >> notes.md

      - name: Create pre-release
        uses: softprops/action-gh-release@v2
        with:
          prerelease: true
          tag_name: v${{ needs.build-native.outputs.version }}-${{ needs.build-native.outputs.environment }}.${{ github.run_number }}
          name: v${{ needs.build-native.outputs.version }}-${{ needs.build-native.outputs.environment }}.${{ github.run_number }}
          body_path: notes.md
          files: ./dist/${{ needs.build-native.outputs.artifact-name }}/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ========================================
  # æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹
  # ========================================
  release:
    name: Production Release
    needs: build-native
    if: |
      github.ref == 'refs/heads/main' || 
      (github.event_name == 'workflow_dispatch' && inputs.release_type == 'release')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./dist

      - name: Debug artifact structure
        run: |
          echo "=== Working directory ==="
          pwd
          ls -la ./
          echo "=== Check if dist exists ==="
          if [ -d "./dist" ]; then
            echo "dist directory exists"
            find ./dist -type f -name "*.dmg" | head -10
            echo "=== All files in dist ==="
            ls -la ./dist/
            if [ -d "./dist/${{ needs.build-native.outputs.artifact-name }}" ]; then
              echo "=== DMG files in ${{ needs.build-native.outputs.artifact-name }} ==="
              ls -la ./dist/${{ needs.build-native.outputs.artifact-name }}/
            fi
          else
            echo "âŒ dist directory does not exist"
            echo "=== Available artifacts might be ==="
            find . -name "*.dmg" 2>/dev/null || echo "No DMG files found"
          fi

      - name: Check for existing release
        id: check_release
        run: |
          if gh release view "v${{ needs.build-native.outputs.version }}" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate changelog
        if: steps.check_release.outputs.exists == 'false'
        id: changelog
        run: |
          echo "## ðŸŽ‰ Production Release v${{ needs.build-native.outputs.version }}" > changelog.md
          echo "" >> changelog.md
          echo "### ðŸ“… Build Information" >> changelog.md
          echo "- **Environment**: Production" >> changelog.md
          echo "- **Version**: ${{ needs.build-native.outputs.version }}" >> changelog.md
          echo "- **App ID**: com.prompalette.app" >> changelog.md
          echo "- **Window Title**: PromPalette" >> changelog.md
          echo "- **Data Directory**: PromPalette/" >> changelog.md
          echo "" >> changelog.md
          echo "### ðŸ“¦ Downloads" >> changelog.md
          echo "Download the installer for macOS below." >> changelog.md
          echo "" >> changelog.md
          echo "### ðŸ”§ Installation" >> changelog.md
          echo "1. Download the .dmg file" >> changelog.md
          echo "2. Open the downloaded file" >> changelog.md
          echo "3. Drag PromPalette to your Applications folder" >> changelog.md
          echo "4. On first launch, you may need to right-click and select 'Open' due to macOS security settings" >> changelog.md
          echo "" >> changelog.md
          
          # å‰å›žã®ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ã‚’å–å¾—
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "### ðŸ“ Changes since $PREV_TAG" >> changelog.md
            echo "" >> changelog.md
            git log --pretty=format:"- %s" "$PREV_TAG"..HEAD | grep -E "^- (feat|fix|perf|refactor):" >> changelog.md || echo "- Various improvements and bug fixes" >> changelog.md
          else
            echo "### ðŸ“ Initial Release" >> changelog.md
            echo "- First release of PromPalette" >> changelog.md
          fi
          
          echo "" >> changelog.md
          echo "### ðŸ”— Links" >> changelog.md
          echo "- [Documentation](https://github.com/${{ github.repository }}/wiki)" >> changelog.md
          echo "- [Report Issues](https://github.com/${{ github.repository }}/issues)" >> changelog.md

      - name: Create production release
        if: steps.check_release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          prerelease: false
          tag_name: v${{ needs.build-native.outputs.version }}
          name: v${{ needs.build-native.outputs.version }}
          body_path: changelog.md
          files: ./dist/${{ needs.build-native.outputs.artifact-name }}/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update existing release
        if: steps.check_release.outputs.exists == 'true'
        run: |
          echo "Release v${{ needs.build-native.outputs.version }} already exists. Skipping creation."
          echo "To create a new release, please update the version in package.json."