name: Release Native App

on:
  push:
    branches:
      - staging
      - main
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'prerelease'
        type: choice
        options:
          - prerelease
          - release

permissions:
  contents: write

env:
  PNPM_VERSION: 8
  NODE_VERSION: 20

jobs:
  # ========================================
  # ビルド: macOS向けネイティブアプリ
  # ========================================
  build-native:
    name: Build Native App
    runs-on: macos-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm run --filter "./packages/**" build

      - name: Get version
        id: version
        run: |
          VERSION=$(node -p "require('./apps/native/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Setup Apple Code Signing (if credentials available)
        if: ${{ env.APPLE_CERTIFICATE_BASE64 != '' && env.APPLE_CERTIFICATE_PASSWORD != '' }}
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo "🔑 Setting up Apple Developer ID code signing..."
          
          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          
          # Import certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          
          # Set signing identity
          echo "APPLE_SIGNING_IDENTITY=$(security find-identity -v -p codesigning build.keychain | grep 'Developer ID Application' | head -1 | grep -o '[A-Z0-9]\{40\}')" >> $GITHUB_ENV
          
          echo "✅ Code signing setup completed"

      - name: Build Tauri app (Universal)
        run: |
          if [[ -n "$APPLE_SIGNING_IDENTITY" ]]; then
            echo "🔏 Building with code signing..."
            export TAURI_SIGNING_PRIVATE_KEY="${{ secrets.TAURI_PRIVATE_KEY }}"
            export TAURI_SIGNING_PRIVATE_KEY_PASSWORD="${{ secrets.TAURI_KEY_PASSWORD }}"
          else
            echo "⚠️ Building without code signing (credentials not available)"
            echo "For production releases, please configure Apple Developer ID signing"
          fi
          
          export CI=true
          export SKIP_JENKINS=1
          
          echo "🏗️ Attempting Universal Binary build..."
          if pnpm --filter apps/native tauri build --target universal-apple-darwin --bundles dmg --verbose; then
            echo "✅ Universal build successful"
          else
            echo "❌ Universal build failed, trying native architecture..."
            pnpm --filter apps/native tauri build --bundles dmg --verbose
          fi

      - name: Debug build output
        run: |
          echo "=== Build Target Directories ==="
          ls -la apps/native/src-tauri/target/ || echo "No target directory"
          
          echo "=== Universal Target Check ==="
          if [ -d "apps/native/src-tauri/target/universal-apple-darwin" ]; then
            echo "Universal target directory exists"
            ls -la apps/native/src-tauri/target/universal-apple-darwin/
            if [ -d "apps/native/src-tauri/target/universal-apple-darwin/release" ]; then
              ls -la apps/native/src-tauri/target/universal-apple-darwin/release/
              if [ -d "apps/native/src-tauri/target/universal-apple-darwin/release/bundle" ]; then
                ls -la apps/native/src-tauri/target/universal-apple-darwin/release/bundle/
                if [ -d "apps/native/src-tauri/target/universal-apple-darwin/release/bundle/dmg" ]; then
                  echo "DMG directory exists:"
                  ls -la apps/native/src-tauri/target/universal-apple-darwin/release/bundle/dmg/
                else
                  echo "❌ DMG directory not found"
                fi
              else
                echo "❌ Bundle directory not found"
              fi
            else
              echo "❌ Release directory not found"
            fi
          else
            echo "❌ Universal target directory not found"
          fi
          
          echo "=== All DMG files in target ==="
          find apps/native/src-tauri/target -name "*.dmg" -type f 2>/dev/null || echo "No DMG files found anywhere"
          
          echo "=== Alternative architectures ==="
          ls -la apps/native/src-tauri/target/ | grep -E "(aarch64|x86_64|release)" || echo "No alternative targets"
          
      - name: Check for DMG files
        id: check_dmg
        run: |
          DMG_FOUND=""
          DMG_PATH=""
          
          # Check Universal Binary location first
          if ls apps/native/src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg 1> /dev/null 2>&1; then
            DMG_FOUND="true"
            DMG_PATH="apps/native/src-tauri/target/universal-apple-darwin/release/bundle/dmg"
            echo "✅ Universal DMG files found at: $DMG_PATH"
          # Check native architecture locations
          elif ls apps/native/src-tauri/target/*/release/bundle/dmg/*.dmg 1> /dev/null 2>&1; then
            DMG_FOUND="true"
            DMG_PATH=$(find apps/native/src-tauri/target -name "*.dmg" -type f | head -1 | xargs dirname)
            echo "✅ Native DMG files found at: $DMG_PATH"
          # Check any other location
          elif find apps/native/src-tauri/target -name "*.dmg" -type f | head -1; then
            DMG_FOUND="true"
            DMG_PATH=$(find apps/native/src-tauri/target -name "*.dmg" -type f | head -1 | xargs dirname)
            echo "✅ DMG files found at: $DMG_PATH"
          else
            DMG_FOUND="false"
            echo "❌ No DMG files found anywhere"
          fi
          
          echo "dmg_exists=$DMG_FOUND" >> $GITHUB_OUTPUT
          echo "dmg_path=$DMG_PATH" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        if: steps.check_dmg.outputs.dmg_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: ${{ steps.check_dmg.outputs.dmg_path }}/*.dmg
          if-no-files-found: error
          retention-days: 7

      - name: Verify artifact upload
        run: |
          echo "=== Verifying DMG files exist before upload ==="
          ls -la apps/native/src-tauri/target/universal-apple-darwin/release/bundle/dmg/ || echo "❌ DMG directory not found"
          echo "=== DMG files ==="
          find apps/native/src-tauri/target/universal-apple-darwin/release/bundle/dmg/ -name "*.dmg" 2>/dev/null || echo "No DMG files"

  # ========================================
  # Stagingプレリリース
  # ========================================
  prerelease:
    name: Pre-release (Staging)
    needs: build-native
    if: |
      github.ref == 'refs/heads/staging' || 
      (github.event_name == 'workflow_dispatch' && inputs.release_type == 'prerelease')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./dist

      - name: Debug artifact structure
        run: |
          echo "=== Working directory ==="
          pwd
          ls -la ./
          echo "=== Check if dist exists ==="
          if [ -d "./dist" ]; then
            echo "dist directory exists"
            find ./dist -type f -name "*.dmg" | head -10
            echo "=== All files in dist ==="
            ls -la ./dist/
            if [ -d "./dist/macos-universal" ]; then
              echo "=== DMG files in macos-universal ==="
              ls -la ./dist/macos-universal/
            fi
          else
            echo "❌ dist directory does not exist"
            echo "=== Available artifacts might be ==="
            find . -name "*.dmg" 2>/dev/null || echo "No DMG files found"
          fi

      - name: Generate release notes
        id: notes
        run: |
          echo "## 🚧 Staging Pre-release v${{ needs.build-native.outputs.version }}-staging.${{ github.run_number }}" > notes.md
          echo "" >> notes.md
          echo "### 📅 Build Information" >> notes.md
          echo "- **Version**: ${{ needs.build-native.outputs.version }}-staging.${{ github.run_number }}" >> notes.md
          echo "- **Commit**: ${{ github.sha }}" >> notes.md
          echo "- **Build**: #${{ github.run_number }}" >> notes.md
          echo "- **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> notes.md
          echo "" >> notes.md
          echo "### ⚠️ Notice" >> notes.md
          echo "This is a pre-release build for testing purposes. It may contain bugs or incomplete features." >> notes.md
          echo "" >> notes.md
          echo "### 📦 Installation" >> notes.md
          echo "1. Download the .dmg file below" >> notes.md
          echo "2. Open the downloaded file" >> notes.md
          echo "3. Drag PromPalette to your Applications folder" >> notes.md

      - name: Create pre-release
        uses: softprops/action-gh-release@v2
        with:
          prerelease: true
          tag_name: v${{ needs.build-native.outputs.version }}-staging.${{ github.run_number }}
          name: v${{ needs.build-native.outputs.version }}-staging.${{ github.run_number }}
          body_path: notes.md
          files: ./dist/macos-universal/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ========================================
  # 本番リリース
  # ========================================
  release:
    name: Production Release
    needs: build-native
    if: |
      github.ref == 'refs/heads/main' || 
      (github.event_name == 'workflow_dispatch' && inputs.release_type == 'release')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./dist

      - name: Debug artifact structure
        run: |
          echo "=== Working directory ==="
          pwd
          ls -la ./
          echo "=== Check if dist exists ==="
          if [ -d "./dist" ]; then
            echo "dist directory exists"
            find ./dist -type f -name "*.dmg" | head -10
            echo "=== All files in dist ==="
            ls -la ./dist/
            if [ -d "./dist/macos-universal" ]; then
              echo "=== DMG files in macos-universal ==="
              ls -la ./dist/macos-universal/
            fi
          else
            echo "❌ dist directory does not exist"
            echo "=== Available artifacts might be ==="
            find . -name "*.dmg" 2>/dev/null || echo "No DMG files found"
          fi

      - name: Check for existing release
        id: check_release
        run: |
          if gh release view "v${{ needs.build-native.outputs.version }}" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate changelog
        if: steps.check_release.outputs.exists == 'false'
        id: changelog
        run: |
          echo "## 🎉 Release v${{ needs.build-native.outputs.version }}" > changelog.md
          echo "" >> changelog.md
          echo "### 📦 Downloads" >> changelog.md
          echo "Download the installer for macOS below." >> changelog.md
          echo "" >> changelog.md
          echo "### 🔧 Installation" >> changelog.md
          echo "1. Download the .dmg file" >> changelog.md
          echo "2. Open the downloaded file" >> changelog.md
          echo "3. Drag PromPalette to your Applications folder" >> changelog.md
          echo "4. On first launch, you may need to right-click and select 'Open' due to macOS security settings" >> changelog.md
          echo "" >> changelog.md
          
          # 前回のリリースタグを取得
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "### 📝 Changes since $PREV_TAG" >> changelog.md
            echo "" >> changelog.md
            git log --pretty=format:"- %s" "$PREV_TAG"..HEAD | grep -E "^- (feat|fix|perf|refactor):" >> changelog.md || echo "- Various improvements and bug fixes" >> changelog.md
          else
            echo "### 📝 Initial Release" >> changelog.md
            echo "- First release of PromPalette" >> changelog.md
          fi
          
          echo "" >> changelog.md
          echo "### 🔗 Links" >> changelog.md
          echo "- [Documentation](https://github.com/${{ github.repository }}/wiki)" >> changelog.md
          echo "- [Report Issues](https://github.com/${{ github.repository }}/issues)" >> changelog.md

      - name: Create production release
        if: steps.check_release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          prerelease: false
          tag_name: v${{ needs.build-native.outputs.version }}
          name: v${{ needs.build-native.outputs.version }}
          body_path: changelog.md
          files: ./dist/macos-universal/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update existing release
        if: steps.check_release.outputs.exists == 'true'
        run: |
          echo "Release v${{ needs.build-native.outputs.version }} already exists. Skipping creation."
          echo "To create a new release, please update the version in package.json."